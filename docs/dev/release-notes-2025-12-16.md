# Wine Assistant — обновления документации (2025-12-16)

Этот документ фиксирует изменения, которые были сделаны в проекте в ходе последних правок, и предлагает
минимальный набор актуальных инструкций для команды разработки.

## 1) Web UI (/ui)

- UI отдаётся API-сервисом по пути: `GET /ui`.
- Все API-запросы из UI идут **относительными путями** к тому же хосту:
  - Поиск/листинг: `GET /api/v1/products/search?limit=...&offset=...&in_stock=...`
  - Карточка SKU: `GET /api/v1/sku/<CODE>`
  - История цен: `GET /api/v1/sku/<CODE>/price-history`
  - История остатков: `GET /api/v1/sku/<CODE>/inventory-history`
  - Изображение SKU: `GET /sku/<CODE>/image` (используется как fallback, если `image_url` пустой)

- `X-API-Key` задаётся в UI и хранится локально (через `localStorage`).
- Листинг поддерживает **infinite scroll** (автодогрузка страниц по мере прокрутки) и отображает счётчик
  `загружено: N` (сколько реально отрисовано в списке).

Подробнее: см. `docs/dev/web-ui.md`.

## 2) Очистка тестовых данных в БД

Добавлен/актуализирован скрипт для удаления тестовых SKU и связанных записей по FK из Postgres:

- Скрипт: `scripts/cleanup_test_data.py`
- Режим по умолчанию: **DRY-RUN** (только план и подсчёты)
- Для фактического удаления: `--apply`

Скрипт:
- Подхватывает параметры подключения из `.env`/переменных окружения.
- Умеет удалять по `--prefix` и/или точным `--pattern`.
- Перед удалением выводит зависимости по FK и план с количеством строк по каждой таблице.

Подробнее: см. `docs/dev/cleanup-test-data.md`.

## 3) Windows/PowerShell: запросы к API

В PowerShell `curl` часто является алиасом `Invoke-WebRequest`, поэтому заголовок `-H` может не работать как в bash.
Рекомендуемые варианты:

- `curl.exe ... -H "X-API-Key: ..."`
- `Invoke-RestMethod ... -Headers @{ "X-API-Key" = $env:API_KEY }`

Подробнее: см. `docs/dev/windows-powershell-http.md`.

## 4) Правила расчёта цен при импорте

В пайплайне импорта/апсерта цен важно понимать приоритет источников:

- Если в данных присутствует `price_discount` (цена «со скидкой» из файла), она рассматривается как источник истины
  для `price_final_rub`.
- Если есть и расчётная скидка (`discount_pct`/S5), она используется для контроля качества/диагностики и может давать
  предупреждение при расхождении (например: `price_discount mismatch -> file=... vs S5=...`).
- Атрибуты `df.attrs` и переменные окружения (например, `PREFER_S5`) применяются только в тех сценариях, где источники
  данных позволяют выбор (например, если `price_discount` отсутствует/пустая).

Подробнее: см. `docs/dev/pricing-rules.md`.
