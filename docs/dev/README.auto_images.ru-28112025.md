# Автоматический импорт фотографий из Excel-прайсов

Начиная с текущей версии, система автоматически извлекает встроенные изображения из Excel‑файлов прайс‑листа и прикрепляет их к соответствующим товарам (SKU). Это позволяет:

- автоматически наполнять поле `image_url` в таблице `products`;
- использовать реальные изображения бутылок при экспорте поиска (`/export/search?format=xlsx`);
- отображать корректные изображения в PDF-карточках (`/export/sku/<code>?format=pdf`);
- не выполнять ручной сбор изображений.

---

## Как это работает

### 1. Извлечение изображений из Excel

При загрузке файла командой:

```
python -m scripts.load_csv --excel <путь_к_файлу.xlsx>
```

скрипт автоматически выполняет:

1. Чтение Excel через **openpyxl**.
2. Поиск всех встроенных изображений в листе (`ws._images`).
3. Определение строки, к которой прикреплена картинка.
4. Извлечение SKU‑кода из этой строки.
5. Сохранение изображения в директорию:

```
static/images/<SKU>.png|jpg|jpeg
```

6. Формирование публичного URL:

```
http://localhost:18000/static/images/<SKU>.jpeg
```

7. Запись URL в `products.image_url`.

Путь и базовый URL можно переопределить в `.env`:

```
WINE_IMAGE_DIR=/app/static/images
WINE_IMAGE_BASE_URL=http://localhost:18000/static/images
```

---

## 2. Слияние с данными прайс‑листа

После извлечения изображения создаётся `image_map`, который затем сливается
со строками DataFrame по SKU‑коду:

```python
df["image_url"] = df["code"].map(image_map).fillna(df["image_url"])
```

Если картинка уже была в базе, она не перезаписывается.

---

## 3. Что поддерживается

✔ JPEG, PNG, BMP (через `openpyxl`)
✔ Автоматическое определение расширения
✔ Корректная работа внутри Docker

---

## 4. Ограничения

⚠ Формат WMF не поддерживается openpyxl — такие изображения игнорируются.
⚠ Excel-файлы должны содержать встроенные изображения (а не ссылки).

---

## 5. Проверка результата

### Проверить любое изображение в API:

```
curl http://localhost:18000/static/images/D011402.jpeg -v
```

### Проверить экспорт поиска:

```
curl -o wines_with_photos.xlsx   "http://localhost:18000/export/search?format=xlsx"   -H "X-API-Key: <ключ>"
```

Столбец **Фото (URL)** должен быть заполнен.

### Проверить PDF-карточку:

```
curl -o card_D011402.pdf   "http://localhost:18000/export/sku/D011402?format=pdf"   -H "X-API-Key: <ключ>"
```

---

## 6. Логи при успешном импорте

Пример:

```
[images] Extracted images for 247 SKU(s)
[images] image_url merged, non-null count = 247
```

---

## 7. Что даёт автоимпорт изображений

- Полностью автоматизирует визуальное наполнение каталога.
- Упрощает работу менеджеров.
- Делает экспорт Excel и PDF значительно информативнее.
- Снимает необходимость хранить или загружать изображения вручную.
