# Экспорт каталога через веб-интерфейс

Экспорт реализован поверх существующего API и доступен как через Swagger UI, так и из любого
веб-клиента (от простых ссылок до SPA-приложения).

Поддерживаются три основных сценария:

1. Экспорт результатов поиска каталога.
2. Экспорт карточки товара (SKU) в PDF / JSON.
3. Экспорт истории цен по SKU в Excel / JSON.

> Базовый URL для локальной разработки: `http://localhost:18000`.

---

## 1. Работа через Swagger UI (встроенный веб-интерфейс)

### 1.1. Открыть Swagger UI

1. Убедиться, что стенд поднят:
   ```bash
   docker compose up -d
   ```
2. В браузере открыть:
   `http://localhost:18000/docs`

В правом верхнем углу отображается версия API и кнопка **Authorize**.

### 1.2. Авторизация по API-ключу

Все эндпойнты экспорта защищены и требуют API-ключ:

- заголовок: `X-API-Key`
- значение: см. локальную конфигурацию (`.env` / `docker-compose.yml`)

Чтобы авторизоваться в Swagger UI:

1. Нажать кнопку **Authorize**.
2. В поле для `X-API-Key` вставить ключ.
3. Нажать **Authorize** → **Close**.

После этого все запросы из Swagger UI будут автоматически отправляться с нужным заголовком.

---

## 2. Экспорт результатов поиска

Эндпойнт: `/export/search`
Тег в Swagger: **Export**

Поддерживаемые форматы:

- `format=xlsx` — Excel-файл с прайс-листом.
- `format=pdf` — PDF-прайс (по аналогии с `export_search_top100.pdf`).
- `format=json` — «сырые» данные в JSON (удобно для отладки).

Основные параметры запроса:

- `q` — строка поиска (по `title_ru`, `producer`, `region`).
- `country` — фильтр по стране.
- `region` — фильтр по региону.
- `grapes` — фильтр по сорту винограда.
- `in_stock` — если установлен, берутся только позиции с `stock_free > 0`.
- `min_price` / `max_price` — ограничение по цене.
- `limit` — максимальное количество строк в выгрузке (сверху ограничено 1000).

### 2.1. Через Swagger UI

1. В Swagger UI открыть раздел **Export** → операцию **GET /export/search**.
2. Нажать **Try it out**.
3. Заполнить параметры (например, `q=brunello`, `format=xlsx`, `in_stock=true`, `limit=200`).
4. Нажать **Execute**.

Браузер скачает файл:

- `export_search_*.xlsx` — для Excel,
- `export_search_*.pdf` — для печатной версии,
- либо покажет JSON-ответ, если выбран `format=json`.

### 2.2. Использование из клиентского веб-интерфейса

Типичный сценарий для фронтенда:

1. Форма поиска отправляет запрос на публичный эндпойнт:
   `/api/v1/products/search?q=...&country=...&in_stock=1&...`
2. Рядом с таблицей результатов показывается кнопка **Экспорт**.
3. По клику фронтенд собирает те же параметры и открывает URL экспорта:
   `/export/search?format=xlsx&...те же фильтры...`

Важно: так как `/export/...` требует `X-API-Key`, простой `<a href="...">` не подойдёт.
Фронтенд должен делать запрос через JavaScript (например, `fetch`) c заголовком `X-API-Key`
и затем формировать Blob/ссылку для скачивания файла.

---

## 3. Экспорт карточки товара (SKU)

Эндпойнт: `/export/sku/{code}`
Тег в Swagger: **Export**

Поддерживаемые форматы:

- `format=pdf` — карточка товара в PDF (готова к печати / отправке клиенту).
- `format=json` — данные карточки в JSON.

Параметры:

- `code` (path) — код SKU, например `D009704`.
- `format` (query) — `pdf` или `json` (по умолчанию `pdf`).

### 3.1. Через Swagger UI

1. В разделе **Export** выбрать **GET /export/sku/{code}**.
2. Нажать **Try it out**.
3. В поле `code` указать SKU (например, `D009704`).
4. В параметре `format` выбрать `pdf`.
5. Нажать **Execute**.

При успешном ответе браузер скачает файл вида `wine_card_D009704.pdf`.

Если SKU не найден — вернётся 404 и JSON: `{"error": "not_found"}`.

### 3.2. Интеграция в веб-интерфейс

- На странице карточки товара можно добавить кнопку
  **«Скачать карточку (PDF)»**.
- По клику фронтенд вызывает `/export/sku/{code}?format=pdf`
  с заголовком `X-API-Key` и инициирует загрузку файла.

Для отладки можно использовать `format=json`, чтобы увидеть,
какие поля попадают в PDF.

---

## 4. Экспорт истории цен по SKU

Эндпойнт: `/export/price-history/{code}`
Тег в Swagger: **Export**

Поддерживаемые форматы:

- `format=xlsx` — Excel c историей цен (заголовки: «Дата начала», «Дата окончания», «Цена прайс», «Цена финальная»).
- `format=json` — JSON-структура с массивом периодов и цен.

Параметры:

- `code` (path) — код SKU.
- `format` (query) — `xlsx` или `json` (по умолчанию `xlsx`).
- `limit`, `offset` — пагинация (аналогично обычному `/sku/{code}/price-history`).

### 4.1. Через Swagger UI

1. В Swagger открыть **GET /export/price-history/{code}**.
2. Нажать **Try it out**.
3. Заполнить `code` (например, `D009704`), при необходимости — `limit`.
4. Выбрать `format=xlsx`.
5. Нажать **Execute** — Excel-файл будет скачан браузером.

Если для SKU ещё нет истории цен — вернётся 404 и JSON `{"error": "not_found"}`.

### 4.2. Интеграция в веб-интерфейс

На странице истории цен можно:

- показывать график / таблицу, получая данные из REST-эндпойнта
  `/sku/{code}/price-history`,
- рядом разместить кнопку **«Скачать историю цен (Excel)»**,
  которая вызывает `/export/price-history/{code}?format=xlsx`
  с теми же параметрами `limit/offset` (и заголовком `X-API-Key`).

---

## 5. Ограничения и best practices

- **Лимит строк.** Для экспорта поиска лимит жёстко ограничен сверху значением `1000`,
  чтобы не перегрузить базу и не генерировать слишком тяжёлые файлы.
- **Фильтры должны совпадать.** Рекомендуется всегда передавать в `/export/search`
  те же параметры, что использовались при обычном поиске каталога — тогда
  выгрузка будет точно соответствовать тому, что видит пользователь в интерфейсе.
- **JSON для отладки.** Формат `json` полезен при разработке фронтенда:
  можно быстро проверить состав полей и структуру ответа, не открывая Excel/PDF.
- **Безопасность.** API-ключ должен храниться только на серверной стороне
  или в защищённой конфигурации фронтенда (например, в backend-proxy),
  а не захардкожен в клиентском JavaScript.
