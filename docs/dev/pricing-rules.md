# Правила расчёта цен при импорте (price_list_rub / price_final_rub)

Этот документ описывает ожидаемое поведение логики импорта/апсерта цен, чтобы:
- тесты отражали реальную бизнес-логику;
- команда одинаково трактовала «источник истины».

## Термины
- `price_list_rub` — цена из прайс-листа (базовая).
- `price_discount` — цена «со скидкой», если она прямо указана в источнике данных.
- `discount_pct` / «S5» — расчётная скидка (например, из отдельной ячейки/поля), позволяющая вычислить финальную цену:
  `price_s5 = price_list_rub * (1 - discount_pct)`.

## Приоритеты
1) Если `price_discount` присутствует и валидна, она используется как `price_final_rub`.
2) Если `price_discount` отсутствует/пустая, `price_final_rub` может быть рассчитана из `discount_pct` и `price_list_rub`.
3) Если доступны оба значения (`price_discount` и `price_s5`) и они расходятся, это повод для предупреждения/диагностики
   качества данных, но не обязательно повод менять приоритет.

## Атрибуты DataFrame и переменные окружения
- `df.attrs["prefer_discount_cell"]` и переменная окружения `PREFER_S5` применяются только там, где логика допускает выбор,
  например если в источнике нет явного `price_discount`, или если источник представлен несколькими альтернативными колонками.
- Если явное значение `price_discount` присутствует, оно рассматривается как более «сильный» сигнал, чем расчётная величина.

## Почему это важно для тестов
При фиксации приоритетов в тестах важно проверять:
- какое значение реально уходит в `INSERT INTO products ... price_final_rub`;
- что mismatch-логирование (если есть) не меняет рассчитанное значение без явного правила.

Пример mismatch:
- `price_list_rub = 100`
- `discount_pct = 0.2` ⇒ `price_s5 = 80`
- `price_discount = 90`
Ожидаемое поведение: `price_final_rub = 90`, и вывод диагностического предупреждения о расхождении.
