# Очистка тестовых данных в Postgres

Скрипт предназначен для удаления тестовых записей из `products` (и зависимых таблиц по FK, где FK указывает на `products.code`).

## Скрипт
- Путь: `scripts/cleanup_test_data.py`

## Подключение к БД
Скрипт пытается взять параметры подключения из окружения и/или из `.env`.

Рекомендуемая практика:
- держать локальный `.env` только для разработки (он должен быть в `.gitignore`);
- хранить пример значений в `.env.example`.

Пример типовых параметров, которые часто используются в проекте:
- `DB_HOST`, `DB_PORT`, `DB_NAME`, `DB_USER`, `DB_PASSWORD`
- и/или стандартные `PGHOST`, `PGPORT`, `PGDATABASE`, `PGUSER`, `PGPASSWORD`

## Режимы работы
- По умолчанию — DRY-RUN: скрипт показывает план и ничего не удаляет.
- Чтобы удалить реально: добавьте `--apply`.

## Выбор того, что удалять
Поддерживаются два основных способа:

### 1) По префиксу
Удаляет все `code`, начинающиеся с указанного префикса (LIKE '<prefix>%'):
```bash
python scripts/cleanup_test_data.py --prefix INTTEST_
```

### 2) По точным кодам/паттернам
Удаляет конкретные коды (или наборы кодов по LIKE-паттернам, если вы их используете):
```bash
python scripts/cleanup_test_data.py --pattern D011352 --pattern D011331
```

## Выполнение удаления (APPLY)
```bash
python scripts/cleanup_test_data.py --pattern D011352 --pattern D011331 --apply
```

## Что делает скрипт перед удалением
- Находит коды в основной таблице (`products`).
- Находит FK-зависимости (child -> parent).
- Считает объём удалений по каждой таблице.
- В режиме `--apply` удаляет сначала зависимые записи, затем `products`.

## Полезные замечания
- В CLI сейчас нет флага `--yes` (подтверждение выполняется фактом указания `--apply`).
- Если вы используете секционирование таблиц цен (partitioned), убедитесь, что скрипт учитывает все партиции, которые могут содержать данные по `code`.
