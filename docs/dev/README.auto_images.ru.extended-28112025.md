# Автоимпорт фотографий товаров из Excel и экспорт ссылок на изображения

## Кратко

В этом Merge Request реализован автоматический импорт фотографий вин из Excel‑прайсов в файловое хранилище внутри контейнера и сохранение ссылки на изображение в поле `products.image_url`.
Далее эти ссылки автоматически:

- попадают в XLSX‑экспорт поиска (`Фото (URL)`),
- используются в PDF‑карточке товара (если картинка есть).

## Основные изменения

### 1. Извлечение картинок из Excel

- Добавлен модуль `etl/image_extractor.py` с функцией:

  ```python
  extract_images_from_excel(
      excel_path: str | Path,
      header_row_zero_based: int = 3,
      code_header: str = "Код",
      output_dir: str | Path | None = None,
      image_base_url: str | None = None,
  ) -> dict[str, str]
  ```

- Логика:
  - Открываем прайс через `openpyxl`, берём первый лист (`ws = wb.active`).
  - Находим строку заголовков (параметр `header_row_zero_based`, сейчас 3 → строка 4 в Excel).
  - Ищем колонку с кодом товара по заголовку `Код`.
  - Строим мапу «строка Excel → SKU код».
  - Проходим по всем встроенным изображениям `ws._images`:
    - определяем строку привязки картинки через `img.anchor._from.row`,
    - по номеру строки находим SKU,
    - сохраняем картинку в файл `<CODE>.<ext>` (например, `D011402.jpeg`),
    - формируем публичный URL картинки и возвращаем словарь `{code: image_url}`.

- Функция аккуратно обрабатывает:
  - отсутствие нужной колонки `Код`,
  - отсутствие картинок на листе,
  - поддерживаемые форматы картинок (по `img.format`, дефолт — `png`),
  - дубликаты — для одного SKU не перезаписываем уже найденное изображение.

### 2. Интеграция автоимпорта в скрипт загрузки прайсов

- В `scripts/load_csv.py` добавлен шаг автоимпорта картинок **после** чтения Excel в `DataFrame`, но **до** сохранения в БД:

  - Вызывается `extract_images_from_excel(...)` с параметрами:
    - `excel_path` — путь к текущему Excel‑файлу (из `--excel`),
    - `header_row_zero_based=3` — соответствует текущей конфигурации импорта,
    - `code_header="Код"`,
    - `output_dir` и `image_base_url` берутся из переменных окружения (см. ниже).
  - Полученная мапа `{code: image_url}` через `pandas.Series.map` мержится в колонку `df["image_url"]`.
  - В логах выводится:
    - сколько картинок удалось извлечь,
    - сколько непустых значений `image_url` получилось после merge.

- При ошибках в процессе извлечения (например, проблемы с файловой системой) импорт **не падает**:
  - ошибка логируется в консоль (`[images] Failed to extract images from Excel` + traceback),
  - `image_map` считается пустым, импорт продолжается в штатном режиме (без заполнения `image_url`).

### 3. Новые переменные окружения для картинок

В `.env` добавлены переменные:

```dotenv
# === Wine images (optional) ===
WINE_IMAGE_DIR=/app/static/images
WINE_IMAGE_BASE_URL=http://localhost:18000/static/images
```

- `WINE_IMAGE_DIR` — каталог внутри контейнера, куда скрипт `load_csv.py` складывает файлы изображений (например, `/app/static/images/D011402.jpeg`).
- `WINE_IMAGE_BASE_URL` — базовый URL, который попадает в `products.image_url`:
  - итоговый URL имеет вид
    `http://localhost:18000/static/images/<CODE>.<ext>`

Эти переменные позволяют при необходимости:

- поменять физическое расположение картинок (например, вынести в другой том),
- поменять публичный домен / путь (например, `https://cdn.example.com/wines/...`).

### 4. Настройка Docker и статики

#### Dockerfile

- В `Dockerfile` подготовлена среда для работы API и генерации PDF, включая шрифты.
- Исходники приложения копируются в `/app`, где:
  - исполняется API,
  - располагается каталог `static` (в т.ч. `static/images`).

#### docker-compose.yml

- Сервис `api`:
  - поднимает контейнер с приложением на порту `8000` (проброшен наружу на `localhost:18000`),
  - использует `gunicorn` как WSGI‑сервер.
- Внутри контейнера:
  - каталог `/app/static` доступен Flask как статическая директория,
  - изображения, сохранённые в `/app/static/images`, автоматически раздаются по URL
    `/static/images/<filename>`.

Таким образом, после импорта прайса картинки доступны по тем URL, которые мы сохраняем в БД.

### 5. Экспорт XLSX и PDF‑карточка

#### XLSX‑экспорт поиска

- В `GET /export/search?format=xlsx`:
  - уже существующая колонка `Фото (URL)` теперь заполняется значениями из `products.image_url`.
  - Колонка `Сайт производителя` заполняется данными из `products.producer_site`.

Ручной визуальный чек:

- Скачан `wines_with_photos.xlsx` от `GET /export/search?format=xlsx`.
- Проверено:
  - заголовки включают колонку `Фото (URL)`,
  - в колонке «Сайт производителя» — осмысленные, валидные ссылки (включая производителй из прайса),
  - в колонке «Фото (URL)» — непустые значения для SKU, у которых в Excel были встроенные картинки.

#### PDF‑карточка товара

- В `GET /export/sku/<code>?format=pdf`:
  - если для товара есть `image_url`, в PDF‑карточке выводится фотография бутылки,
  - в противном случае карточка генерируется как раньше, без картинки.

Ручной визуальный чек:

- Для SKU `D011402`:
  - `GET /export/sku/D011402?format=json` показывает поле:
    - `image_url: "http://localhost:18000/static/images/D011402.jpeg"`
  - запросом из PowerShell скачан PDF:

    ```powershell
    $sku = "D011402"
    $cardUrl = "$baseUrl/export/sku/$($sku)?format=pdf"
    Invoke-WebRequest -Uri $cardUrl -Headers $headers -OutFile ".\card_$sku.pdf"
    ```

  - при открытии `card_D011402.pdf` видна фотография бутылки.

## Тестирование

### Автотесты

- Запуск автотестов (с включёнными интеграционными тестами БД):

  ```powershell
  $env:RUN_DB_TESTS = "1"
  pytest -q -rs
  ```

- Результат: `164 passed` — все тесты успешно проходят.

Особое внимание:

- Интеграционные тесты экспорта (`tests/integration/test_api_export_search.py`, `test_api_export_sku_and_price_history.py`) проходят без изменений — формат ответа и базовые поля не ломались.
- Юнит‑тесты `test_export_service.py`, `test_schemas.py` подтверждают, что:
  - схема ответа `/api/v1/products/search` и экспорт в XLSX соответствуют ожиданиям,
  - новая колонка `Фото (URL)` корректно присутствует в наборе по умолчанию.

### Ручная проверка

1. Подъём окружения в Docker:

   ```powershell
   docker compose down -v
   docker compose build
   docker compose up -d
   ```

2. Проверка живости API:

   ```powershell
   $baseUrl = "http://localhost:18000"
   Invoke-RestMethod "$baseUrl/live"
   Invoke-RestMethod "$baseUrl/ready"
   Invoke-RestMethod "$baseUrl/health"
   ```

3. Загрузка Excel‑прайсов и автоимпорт картинок:

   ```powershell
   $files = @(
     ".\data\inbox\Копия 2025_01_20 Прайс_Легенда_Виноделия.xlsx",
     ".\data\inbox5_06_03 Прайс_Легенда_Виноделия.xlsx",
     ".\data\inbox5_06_25 Прайс_Легенда_Виноделия.xlsx",
     ".\data\inbox5_08_06 Прайс_Легенда_Виноделия.xlsx",
     ".\data\inbox5_08_19 Прайс_Легенда_Виноделия.xlsx",
     ".\data\inbox5_09_29 Прайс_Легенда_Виноделия.xlsx",
     ".\data\inbox5_10_22 Прайс_Легенда_Виноделия.xlsx",
     ".\data\inbox5_10_27 Прайс_Легенда_Виноделия.xlsx"
   )
   foreach ($f in $files) {
       Write-Host ">>> Импорт $f"
       python -m scripts.load_csv --excel $f
   }
   ```

   В логах видно, что:

   - определяется дата прайса,
   - импорт завершается успешно (`[OK] Import completed successfully`),
   - выводятся сообщения вида:

     ```text
     [images] Extracted images for N SKU(s)
     [images] image_url merged, non-null count = M
     ```

4. Проверка, что картинки реально лежат «за URL»:

   ```powershell
   curl http://localhost:18000/static/images/D011402.jpeg -v
   ```

   Результат — `StatusCode: 200` и ответ с `Content-Type: image/jpeg`.

5. Проверка экспорта:

   - `GET /export/search?format=xlsx` → открыть `wines_with_photos.xlsx` и убедиться:
     - колонка `Фото (URL)` существует и содержит ссылки по ожидаемым SKU,
     - колонка `Сайт производителя` заполнена корректно.
   - `GET /export/sku/D011402?format=pdf` → открыть `card_D011402.pdf` и визуально проверить наличие фото.

## Обратная совместимость и риски

- Для инсталляций, где нет картинок в Excel, поведение почти не меняется:
  - `extract_images_from_excel` тихо вернёт пустую мапу,
  - `image_url` останется `NULL` / пустым,
  - экспорт XLSX и PDF будут вести себя как раньше (без фотографий).
- Импорт прайса не падает при:
  - неподдерживаемых форматах изображений (openpyxl выдаёт `UserWarning`, картинка пропускается),
  - ошибках файловой системы при сохранении картинки — ошибка логируется, импорт продолжается.
- При смене доменного имени / порта достаточно скорректировать `WINE_IMAGE_BASE_URL` и выполнить повторный импорт (для новых прайсов); существующие значения `image_url` в БД можно переобновить отдельным скриптом при необходимости.

## Резюме

- Прайсы из Excel теперь автоматически «тащат» за собой фотографии бутылок.
- Картинки единообразно хранятся в каталоге статики контейнера и доступны по HTTP.
- Экспорт в XLSX и PDF‑карточка автоматически используют `image_url`, без дополнительных ручных действий.
- Все существующие автотесты зелёные; добавлена ручная проверка выгружаемых отчётов и доступности картинок.
