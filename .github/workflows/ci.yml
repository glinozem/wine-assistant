name: CI

on:
  push:
  pull_request:

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  tests:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16-alpine
        ports:
          - 15432:5432         # host:container
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: dev_local_pw
          POSTGRES_DB: wine_db
        options: >-
          --health-cmd="pg_isready -U postgres -d wine_db"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10

    env:
      # ðŸ”§ Ð’ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ð¾Ð½Ð½Ñ‹Ðµ Ñ‚ÐµÑÑ‚Ñ‹ Ð¸ Ð½Ð°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ðº Ð‘Ð”
      RUN_DB_TESTS: "1"
      PGHOST: localhost
      PGPORT: "15432"
      PGUSER: postgres
      PGPASSWORD: dev_local_pw
      PGDATABASE: wine_db

      # Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð¼Ð¾Ð¶Ð½Ð¾ Ð²ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ (Ð¿Ñ€Ð¸Ð¼ÐµÑ€):
      # RATE_LIMIT_ENABLED: "0"
      # API_KEY: test-key

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libpq-dev postgresql-client

      - name: Wait for Postgres
        shell: bash
        run: |
          for i in {1..30}; do
            if pg_isready -h "$PGHOST" -p "$PGPORT" -d "$PGDATABASE" -U "$PGUSER"; then
              echo "Postgres is ready"
              break
            fi
            echo "Waiting for Postgres ($i/30)..."
            sleep 2
          done

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi

      - name: Prepare schema (optional)
        # ÐŸÑ€Ð¸Ð¼ÐµÐ½ÑÐµÐ¼ ÑÑ…ÐµÐ¼Ñƒ/Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸, ÐµÑÐ»Ð¸ Ð¾Ð½Ð¸ ÐµÑÑ‚ÑŒ Ð² Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¸
        shell: bash
        run: |
          set -e
          CONN_STR="postgresql://${PGUSER}:${PGPASSWORD}@${PGHOST}:${PGPORT}/${PGDATABASE}"
          if [ -f db/schema.sql ]; then
            echo "Applying db/schema.sql"
            psql "$CONN_STR" -f db/schema.sql
          fi
          if [ -d db/migrations ]; then
            shopt -s nullglob
            for f in db/migrations/*.sql; do
              echo "Applying migration: $f"
              psql "$CONN_STR" -f "$f"
            done
          fi

      - name: Run tests
        run: |
          pytest -q

      - name: Install pip-audit
        run: |
          pip install pip-audit

      - name: Security audit (pip-audit)
        # Ð•ÑÐ»Ð¸ Ð½Ð°Ð¹Ð´ÑƒÑ‚ÑÑ ÑƒÑÐ·Ð²Ð¸Ð¼Ð¾ÑÑ‚Ð¸ â€” ÑˆÐ°Ð³ Ð·Ð°Ñ„ÐµÐ¹Ð»Ð¸Ñ‚ÑÑ (ÐºÐ°Ðº Ð¸ Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ)
        run: |
          pip-audit -r requirements.txt

      - name: Semgrep (OWASP Top 10)
        # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð¾Ñ„Ð¸Ñ†Ð¸Ð°Ð»ÑŒÐ½Ñ‹Ð¹ action; Ð¸ÑÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ Ð»Ð¾Ð¶Ð½Ð¾Ð¿Ð¾Ð»Ð¾Ð¶Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ðµ Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð¾ Ð¿Ñ€Ð¾ 0.0.0.0
        uses: returntocorp/semgrep-action@v1
        with:
          config: p/owasp-top-ten
          args: >-
            --exclude-rule python.flask.security.audit.app-run-param-config.avoid_app_run_with_bad_host
          generateSarif: true

      - name: Upload Semgrep SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: semgrep.sarif
